<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DWeb Hosting Network</title>
    <link rel="stylesheet" href="panel.css" />
  </head>
  <body>
    <div id="publishModal" class="modal-overlay hidden">
      <div class="modal-content publish-modal">
        <button class="modal-close" id="closePublishModal">&times;</button>
        
        <div id="publishStep1" class="publish-step-view active">
          <h2>Publish Application</h2>
          <p class="modal-subtitle">Step 1: Select your app folder</p>
          
          <div class="folder-picker">
            <input id="publishFolderInput" type="file" webkitdirectory directory multiple style="display:none;" />
            <button id="selectFolderBtn" class="folder-picker-btn">
              <span class="folder-icon">üìÅ</span>
              <span>Choose Folder</span>
            </button>
            <p id="selectedFolderName" class="selected-folder-hint">No folder selected</p>
          </div>
          
          <div class="modal-actions">
            <button id="cancelPublishBtn" class="secondary">Cancel</button>
            <button id="startPublishBtn" class="primary" disabled>Next</button>
          </div>
        </div>
        
        <div id="publishStep2" class="publish-step-view">
          <h2>Publishing...</h2>
          <div class="progress-container">
            <div class="progress-step">
              <span class="progress-icon" id="progressIcon1">‚è≥</span>
              <span id="progressText1">Preparing manifest...</span>
            </div>
            <div class="progress-step">
              <span class="progress-icon" id="progressIcon2">‚è≥</span>
              <span id="progressText2">Replicating to network...</span>
              <span id="progressPeers" class="progress-sub">0/3 peers</span>
            </div>
            <div class="progress-step">
              <span class="progress-icon" id="progressIcon3">‚è≥</span>
              <span id="progressText3">Registering manifest...</span>
            </div>
          </div>
        </div>
        
        <div id="publishStep3" class="publish-step-view">
          <h2>Almost Done!</h2>
          <p class="modal-subtitle">Bind your app to a .dweb domain</p>
          
          <div class="domain-bind-form">
            <label for="modalDomainInput">Domain name</label>
            <div class="domain-input-group">
              <input id="modalDomainInput" type="text" placeholder="myapp" />
              <span class="domain-suffix">.dweb</span>
              <button id="checkDomainBtn" class="secondary small">Check</button>
            </div>
            <p id="domainAvailability" class="domain-hint"></p>
          </div>
          
          <div class="modal-actions">
            <button id="skipDomainBtn" class="secondary">Skip for Now</button>
            <button id="bindDomainBtn" class="primary" disabled>Bind & Finish</button>
          </div>
        </div>
      </div>
    </div>

    <div id="authOverlay" class="auth-overlay hidden">
      <div class="auth-modal">
        <h1>Welcome to DWeb</h1>
        <p class="auth-subtitle">Choose how you want to get started.</p>

        <div class="auth-actions">
          <button id="authGuestBtn" class="primary">Continue as guest</button>
          <button id="authPasskeyBtn" class="secondary">Sign in with passkey</button>
          <button id="authMagicLinkBtn" class="linkish">Send magic link</button>
        </div>
      </div>
    </div>

    <div class="panel-shell">
      <aside class="sidebar">
        <div class="sidebar-header">
          <div>
            <h2>DWeb Panel</h2>
            <p id="sidebarOwnerId" class="owner-id">Owner: ‚Äî</p>
          </div>
          <span id="sidebarStatusBadge" class="status-pill status-unknown">Unknown</span>
        </div>

        <nav class="sidebar-nav">
          <button class="nav-item active" data-view="dashboard">Dashboard</button>
          <button class="nav-item" data-view="publish">Publish</button>
          <button class="nav-item" data-view="domains">Domains</button>
          <button class="nav-item" data-view="peers">Peers</button>
          <button class="nav-item" data-view="activity">Activity</button>
          <button class="nav-item" data-view="settings">Settings</button>
        </nav>

        <div class="sidebar-footer">
          <button id="openResolverFromSidebar" class="outline">Open Resolver</button>
        </div>
      </aside>

      <div class="panel-content">
        <header class="topbar">
          <div class="metric-cards">
            <div class="metric-card">
              <p class="metric-title">Direct Sessions</p>
              <p id="metricDirectRate" class="metric-value">‚Äî</p>
            </div>
            <div class="metric-card">
              <p class="metric-title">Median TTFB</p>
              <p id="metricTtfb" class="metric-value">‚Äî</p>
            </div>
            <div class="metric-card">
              <p class="metric-title">Replication Success</p>
              <p id="metricReplication" class="metric-value">‚Äî</p>
            </div>
            <div class="metric-card">
              <p class="metric-title">Last E2E Run</p>
              <p id="metricE2ERun" class="metric-value">‚Äî</p>
            </div>
          </div>
        </header>

        <section id="view-dashboard" class="view active">
          <div class="dashboard-hero">
            <button id="publishNewAppBtn" class="publish-hero-btn">
              <span class="hero-icon">üì§</span>
              <span class="hero-text">Publish New Application</span>
            </button>
          </div>

          <div class="card">
            <header>
              <h3>Your Applications</h3>
            </header>
            <div id="appsList" class="apps-list">
              <div class="empty-state">
                <p class="empty-icon">üì¶</p>
                <p class="empty-text">No apps yet</p>
                <p class="empty-hint">Click "Publish New Application" to get started!</p>
              </div>
            </div>
          </div>

          <details class="developer-section">
            <summary>Developer Tools</summary>
            <div class="dev-tools-content">
              <div class="card">
                <header>
                  <h3>Connection Status</h3>
                  <button id="connectBtn" class="primary small">Connect</button>
                </header>
                <div class="form-grid">
                  <label for="signalingUrl">Signaling Server URL</label>
                  <input id="signalingUrl" type="text" value="ws://34.107.74.70:8787" />

                  <label for="signalingAuthToken">Signaling Shared Secret</label>
                  <input
                    id="signalingAuthToken"
                    type="password"
                    placeholder="Leave blank if signaling is public"
                    value="choose-a-strong-secret"
                  />

                  <label for="peerId">Peer ID (optional)</label>
                  <input
                    id="peerId"
                    type="text"
                    placeholder="Leave empty to auto-generate"
                  />
                </div>
                <div id="statusLog" class="log"></div>
              </div>
            </div>
          </details>
        </section>

        <section id="view-publish" class="view">
          <div class="card">
            <header>
              <h3>Publish & Replicate</h3>
              <div class="pill-group">
                <span class="pill pill-inline" id="replicationProgressPill">Select file</span>
              </div>
            </header>

            <div class="publish-flow">
              <div class="publish-step">
                <h4>1. Select Content</h4>
                <label for="publishFileInput">Choose file or folder</label>
                <input id="publishFileInput" type="file" webkitdirectory directory multiple />
                <p class="hint" id="publishFileHint">No file selected</p>
                <button id="createManifestBtn" class="primary" disabled>Create Manifest</button>
              </div>

              <div class="publish-step">
                <h4>2. Replicate (RF = 3)</h4>
                <div id="replicationProgress" class="replication-progress">
                  <p class="hint">Create manifest first</p>
                </div>
                <button id="startReplicationBtn" class="primary" disabled>Start Replication</button>
              </div>

              <div class="publish-step">
                <h4>Replica Settings</h4>
                <label class="toggle">
                  <input type="checkbox" id="autoReplicaToggle" checked />
                  <span>Auto-select replica peers</span>
                </label>

                <label for="replicaTargetCount">Max peers per upload</label>
                <input
                  id="replicaTargetCount"
                  type="number"
                  min="1"
                  max="5"
                  value="3"
                />

                <div class="manual-replicas" id="manualReplicaContainer">
                  <p class="hint">Manual selection is available when auto-select is disabled.</p>
                  <div id="manualReplicaList" class="manual-replica-list"></div>
                </div>

                <div class="replication-actions">
                  <button type="button" id="clearManualReplicasBtn" class="secondary-button" disabled>
                    Clear Manual Selections
                  </button>
                  <button type="button" id="resetReplicationSettingsBtn" class="secondary-button">
                    Reset Replication Settings
                  </button>
                </div>
              </div>

              <div class="publish-step">
                <h4>Persistence</h4>
                <label for="storageServiceUrl">Storage Service URL</label>
                <input
                  id="storageServiceUrl"
                  type="text"
                  value="http://34.107.74.70:8789"
                />

                <label for="storageApiKey">Storage API Key</label>
                <input
                  id="storageApiKey"
                  type="password"
                  placeholder="Required when STORAGE_API_KEYS is set"
                  value="storage-test-key"
                />

                <label class="toggle">
                  <input type="checkbox" id="inlineRegistryDataToggle" />
                  <span>Store chunk copies in registry</span>
                </label>

                <label class="toggle">
                  <input type="checkbox" id="storageFallbackToggle" />
                  <span>Upload fallback copies to storage service</span>
                </label>

                <p class="hint">
                  Toggle persistence features: enable to keep fallback copies, disable to rely purely on peer replicas.
                </p>
              </div>
            </div>

            <div class="replication-status" id="replicationStatus"></div>
          </div>

          <div class="card">
            <header>
              <h3>Bind to Domain</h3>
              <div class="pill-group">
                <span class="pill" id="domainBindStatus">No domain bound</span>
              </div>
            </header>
            <div class="form-grid">
              <label for="domainInput">Domain</label>
              <input id="domainInput" type="text" placeholder="example.dweb" />

              <label for="ownerInput">Owner ID</label>
              <input id="ownerInput" type="text" placeholder="user-123" />
            </div>
            <div class="domain-actions">
              <button id="registerDomainBtn" class="primary" disabled>Bind Domain</button>
            </div>
            <div id="registryLog" class="log"></div>
          </div>
        </section>

        <section id="view-domains" class="view">
          <div class="card">
            <header>
              <h3>Domain Management</h3>
              <button id="refreshDomainsBtn" class="secondary-button small">Refresh</button>
            </header>
            <div class="domain-toolbar">
              <input id="domainSearchInput" type="text" placeholder="Search domains‚Ä¶" />
              <button id="addDomainBtn" class="primary">Reserve Domain</button>
            </div>
            <table class="data-table" id="domainTable">
              <thead>
                <tr>
                  <th>Domain</th>
                  <th>Status</th>
                  <th>Manifest</th>
                  <th>Updated</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="domainsTableBody"></tbody>
            </table>
          </div>
        </section>

        <section id="view-peers" class="view">
          <div class="card">
            <header>
              <h3>Active Peers</h3>
              <div class="peer-actions-inline">
                <label class="toggle">
                  <input type="checkbox" id="peerAutoSelectToggle" checked />
                  <span>Auto target selection</span>
                </label>
                <button id="refreshPeersBtn" class="secondary-button small">Refresh</button>
              </div>
            </header>
            <table class="data-table peers-table">
              <thead>
                <tr>
                  <th>Peer</th>
                  <th>Score</th>
                  <th>Latency</th>
                  <th>Success</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="peerTableBody"></tbody>
            </table>
            <div class="peer-detail">
              <label for="peerSelect">Select peer to connect</label>
              <div class="peer-connect">
                <select id="peerSelect"></select>
                <button id="openChannelBtn" disabled>Open Data Channel</button>
              </div>
              <ul id="peerList" class="peer-list"></ul>
            </div>
          </div>
        </section>

        <section id="view-activity" class="view">
          <div class="card">
            <header>
              <h3>Selection Log</h3>
              <div class="export-buttons">
                <button id="selectionExportJson" class="secondary-button small">Copy JSON</button>
                <button id="selectionExportCsv" class="secondary-button small">Copy CSV</button>
              </div>
            </header>
            <div id="selectionLogContainer" class="log large"></div>
          </div>

          <div class="card">
            <header>
              <h3>Direct vs Relay (24h)</h3>
            </header>
            <canvas id="directRelayChart" width="400" height="180"></canvas>
          </div>
        </section>

        <section id="view-settings" class="view">
          <div class="card">
            <header>
              <h3>Feature Toggles</h3>
            </header>
            <div class="toggle-grid">
              <label class="toggle">
                <input type="checkbox" id="togglePeerFirst" checked />
                <span>Peer-first mode</span>
              </label>
              <label class="toggle">
                <input type="checkbox" id="toggleHealthScoring" checked />
                <span>Health scoring</span>
              </label>
              <label class="toggle">
                <input type="checkbox" id="toggleE2EAuto" checked />
                <span>Auto E2E runs</span>
              </label>
              <label class="toggle">
                <input type="checkbox" id="toggleRegistryFallback" />
                <span>Registry fallback</span>
              </label>
            </div>
          </div>

          <div class="card developer-only">
            <header>
              <h3>Developer Settings</h3>
            </header>
            <div class="form-grid">
              <label for="registryUrl">Registry URL</label>
              <input id="registryUrl" type="text" value="http://34.107.74.70:8788" />

              <label for="registryApiKey">Registry API Key</label>
              <input
                id="registryApiKey"
                type="password"
                placeholder="Leave blank if registry is public"
                value="registry-test-key"
              />
            </div>
            <p class="hint">
              Developer settings are hidden in user mode. Toggle developer mode to edit registry/storage/signaling endpoints.
            </p>
          </div>
        </section>
      </div>
    </div>

    <script type="module" src="panel.js"></script>
  </body>
</html>
