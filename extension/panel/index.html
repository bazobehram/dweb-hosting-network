<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DWeb Hosting Network</title>
    <link rel="stylesheet" href="panel.css" />
  </head>
  <body>
    <div id="publishModal" class="modal-overlay hidden">
      <div class="modal-content publish-modal">
        <button class="modal-close" id="closePublishModal">&times;</button>
        
        <div id="publishStep1" class="publish-step-view active">
          <h2>Publish Application</h2>
          <p class="modal-subtitle">Step 1: Select your content</p>
          
          <div id="publishConnectionStatus" class="connection-status-banner hidden">
            <span class="status-icon">‚ö†Ô∏è</span>
            <div class="status-text">
              <strong>No peer connections</strong>
              <p>Your content will be stored in the registry but not replicated. Enable background peer service in Settings for better availability.</p>
            </div>
          </div>
          
          <div class="upload-options">
            <div class="folder-picker">
              <input id="publishFolderInput" type="file" webkitdirectory directory multiple style="display:none;" />
              <button id="selectFolderBtn" class="folder-picker-btn">
                <span class="folder-icon">üìÅ</span>
                <span>Choose Folder</span>
              </button>
            </div>
            
            <div class="file-picker-divider">
              <span>or</span>
            </div>
            
            <div class="file-picker">
              <input id="publishFileInput" type="file" style="display:none;" />
              <button id="selectFileBtn" class="file-picker-btn">
                <span class="file-icon">üìÑ</span>
                <span>Choose File</span>
              </button>
            </div>
          </div>
          
          <p id="selectedContentName" class="selected-content-hint">No content selected</p>
          
          <div class="modal-actions">
            <button id="cancelPublishBtn" class="secondary">Cancel</button>
            <button id="startPublishBtn" class="primary" disabled>Next</button>
          </div>
        </div>
        
        <div id="publishStep2" class="publish-step-view">
          <h2>Publishing...</h2>
          <div class="progress-container">
            <div class="progress-step">
              <span class="progress-icon" id="progressIcon1">‚è≥</span>
              <span id="progressText1">Preparing manifest...</span>
            </div>
            <div class="progress-step">
              <span class="progress-icon" id="progressIcon2">‚è≥</span>
              <span id="progressText2">Replicating to network...</span>
              <span id="progressPeers" class="progress-sub">0/3 peers</span>
            </div>
            <div class="progress-step">
              <span class="progress-icon" id="progressIcon3">‚è≥</span>
              <span id="progressText3">Registering manifest...</span>
            </div>
          </div>
        </div>
        
        <div id="publishStep3" class="publish-step-view">
          <h2>‚úì Published Successfully!</h2>
          <p class="modal-subtitle">Your app is now replicated across the network</p>
          
          <div class="success-summary">
            <p><strong>Manifest ID:</strong> <code id="publishedManifestId">‚Äî</code></p>
            <p><strong>Chunks:</strong> <span id="publishedChunks">‚Äî</span></p>
            <p><strong>Replicated to:</strong> <span id="publishedPeers">‚Äî</span> peers</p>
          </div>
          
          <div class="quick-domain-binding">
            <h3>Bind to Domain (Optional)</h3>
            <p class="hint">Connect this app to a .dweb domain to make it accessible via a friendly URL</p>
            
            <div class="domain-input-group">
              <input id="quickDomainInput" list="quickDomainsList" type="text" placeholder="my-app" style="flex: 1; border-top-right-radius: 0; border-bottom-right-radius: 0;" />
              <span class="domain-suffix">.dweb</span>
              <datalist id="quickDomainsList"></datalist>
            </div>
            <button id="quickBindDomainBtn" class="primary" style="width: 100%; margin-top: 12px;">Register & Bind Domain</button>
          </div>
          
          <div class="modal-actions">
            <button id="closeSuccessBtn" class="secondary">Done</button>
            <button id="goToDomainsBtn" class="secondary">Manage Domains ‚Üí</button>
          </div>
        </div>
      </div>
    </div>

    <div id="authOverlay" class="auth-overlay hidden">
      <div class="auth-modal">
        <h1>Welcome to DWeb</h1>
        <p class="auth-subtitle">Choose how you want to get started.</p>

        <div class="auth-actions">
          <button id="authGuestBtn" class="primary">Continue as guest</button>
          <button id="authPasskeyBtn" class="secondary">Sign in with passkey</button>
          <button id="authMagicLinkBtn" class="linkish">Send magic link</button>
        </div>
      </div>
    </div>

    <div id="domainBindModal" class="modal-overlay hidden">
      <div class="modal-content domain-bind-modal">
        <button class="modal-close" id="closeDomainBindModal">&times;</button>
        
        <h2>Edit Domain: <span id="bindModalDomainName"></span></h2>
        <p class="modal-subtitle">Manage domain binding and ownership</p>
        
        <div class="domain-bind-section">
          <h3>Bind to Application</h3>
          <div id="bindAppsContainer" class="bind-apps-container">
            <p class="empty-hint">Loading published apps...</p>
          </div>
        </div>
        
        <div class="domain-actions-section">
          <h3>Other Actions</h3>
          <div class="action-buttons-grid">
            <button id="unbindDomainModalBtn" class="secondary">Unbind Domain</button>
            <button id="transferDomainModalBtn" class="secondary">Transfer Ownership</button>
            <button id="deleteDomainModalBtn" class="danger">Delete Domain</button>
          </div>
        </div>
        
        <div class="modal-actions">
          <button id="cancelDomainBindBtn" class="secondary">Cancel</button>
          <button id="saveDomainBindBtn" class="primary">Save Changes</button>
        </div>
      </div>
    </div>

    <div class="panel-shell">
      <aside class="sidebar">
        <div class="sidebar-header">
          <div>
            <h2>DWeb Panel</h2>
            <p id="sidebarOwnerId" class="owner-id">Owner: ‚Äî</p>
          </div>
          <span id="sidebarStatusBadge" class="status-pill status-unknown">Unknown</span>
        </div>

        <nav class="sidebar-nav">
          <button class="nav-item active" data-view="dashboard">Dashboard</button>
<button class="nav-item" data-view="hosting">Publish</button>
          <button class="nav-item" data-view="domains">Domains</button>
          <button class="nav-item" data-view="bindings">Bindings</button>
          <button class="nav-item" data-view="settings">Settings</button>
        </nav>

        <div class="sidebar-footer">
          <button id="openResolverFromSidebar" class="outline">Open Resolver</button>
        </div>
      </aside>

      <div class="panel-content">
        <header class="topbar">
          <div class="metric-cards">
            <div class="metric-card" title="Share of requests served directly by peers in last 24h">
              <p class="metric-title">Direct Sessions</p>
              <p id="metricDirectRate" class="metric-value">‚Äî</p>
            </div>
            <div class="metric-card" title="Median time-to-first-byte from peers or storage">
              <p class="metric-title">Median TTFB</p>
              <p id="metricTtfb" class="metric-value">‚Äî</p>
            </div>
            <div class="metric-card" title="Successful replica uploads in last 24h">
              <p class="metric-title">Replication Success</p>
              <p id="metricReplication" class="metric-value">‚Äî</p>
            </div>
            <div class="metric-card" title="Last end-to-end availability check">
              <p class="metric-title">Last E2E Run</p>
              <p id="metricE2ERun" class="metric-value">‚Äî</p>
            </div>
          </div>
          <div class="network-health-strip" id="networkHealthStrip">
            <span class="pill" id="nhMode">Mode: ‚Äî</span>
            <span class="pill" id="nhPeers">Peers: 0</span>
            <span class="pill" id="nhChannel">Channel: ‚Äî</span>
            <span class="pill" id="nhSignaling">Signaling: ‚Äî</span>
            <span class="pill" id="nhRegistry">Registry: ‚Äî</span>
            <span class="pill" id="nhStorage">Storage: ‚Äî</span>
          </div>
        </header>

        <section id="view-dashboard" class="view active">
          <h2 class="view-title">Network Overview</h2>
          
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-icon">üìö</div>
              <div class="stat-content">
                <div class="stat-label">Published Apps</div>
                <div class="stat-value" id="dashboardAppsCount">0</div>
              </div>
            </div>
            
            <div class="stat-card">
              <div class="stat-icon">üåê</div>
              <div class="stat-content">
                <div class="stat-label">Registered Domains</div>
                <div class="stat-value" id="dashboardDomainsCount">0</div>
              </div>
            </div>
            
            <div class="stat-card">
              <div class="stat-icon">üë•</div>
              <div class="stat-content">
                <div class="stat-label">Connected Peers</div>
                <div class="stat-value" id="dashboardPeersCount">0</div>
              </div>
            </div>
            
            <div class="stat-card">
              <div class="stat-icon">‚ö°</div>
              <div class="stat-content">
                <div class="stat-label">Network Status</div>
                <div class="stat-value" id="dashboardNetworkStatus">Unknown</div>
              </div>
            </div>
          </div>
          
          <div class="card">
            <header>
              <h3>Recent Activity</h3>
            </header>
            <div id="dashboardActivity" class="activity-feed">
              <p class="empty-hint">No recent activity</p>
            </div>
          </div>
          
          <div class="card">
            <header>
              <h3>Quick Actions</h3>
            </header>
            <div class="quick-actions">
              <button class="action-btn" data-goto="hosting">
                <span class="action-icon">üì§</span>
                <span class="action-text">Publish Application</span>
              </button>
              <button class="action-btn" data-goto="domains">
                <span class="action-icon">üåê</span>
                <span class="action-text">Register Domain</span>
              </button>
              <button class="action-btn" id="openResolverDashboard">
                <span class="action-icon">üîç</span>
                <span class="action-text">Open Resolver</span>
              </button>
            </div>
          </div>

        </section>
        
        <section id="view-hosting" class="view">
<h2 class="view-title">Publish & Replicate</h2>
          
          <div class="hosting-hero">
            <button id="publishNewAppBtn" class="publish-hero-btn">
              <span class="hero-icon">üì§</span>
              <span class="hero-text">Publish New Application</span>
            </button>
          </div>

          <div class="card">
            <header>
              <h3>Your Published Applications</h3>
            </header>
            <div id="appsList" class="apps-list">
              <div class="empty-state">
                <p class="empty-icon">üì¶</p>
                <p class="empty-text">No apps published yet</p>
                <p class="empty-hint">Click "Publish New Application" to get started!</p>
              </div>
            </div>
          </div>
          
          <details class="developer-section">
            <summary>Developer Tools & Debugging</summary>
            <div class="dev-tools-content">
              <div class="card">
                <header>
                  <h3>Connection Status</h3>
                  <button id="connectBtn" class="primary small">Reconnect</button>
                </header>
                <div class="form-grid">
                  <label for="signalingUrl">Signaling Server URL</label>
                  <input id="signalingUrl" type="text" value="ws://34.107.74.70:8787" readonly />

                  <label for="signalingAuthToken">Signaling Shared Secret</label>
                  <input
                    id="signalingAuthToken"
                    type="password"
                    placeholder="Leave blank if signaling is public"
                    value="choose-a-strong-secret"
                  />

                  <label for="peerId">Peer ID (optional)</label>
                  <input
                    id="peerId"
                    type="text"
                    placeholder="Leave empty to auto-generate"
                  />
                </div>
                <div id="statusLog" class="log"></div>
              </div>
              
              <div class="card">
                <header>
                  <h3>Active Peers (Debug)</h3>
                  <button id="refreshPeersBtn" class="secondary-button small">Refresh</button>
                </header>
                <table class="data-table peers-table">
                  <thead>
                    <tr>
                      <th>Peer ID</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody id="peerTableBody"></tbody>
                </table>
              </div>
              
              <div class="card">
                <header>
                  <h3>Telemetry & Metrics</h3>
                </header>
                <div id="selectionLogContainer" class="log large"></div>
              </div>
            </div>
          </details>
        </section>

        <section id="view-publish" class="view" style="display:none;">
          <div class="card">
            <header>
              <h3>Publish & Replicate</h3>
              <div class="pill-group">
                <span class="pill pill-inline" id="replicationProgressPill">Select file</span>
              </div>
            </header>

            <div class="publish-flow">
              <div class="publish-step">
                <h4>1. Select Content</h4>
                <label for="publishFileInput">Choose file or folder</label>
                <input id="publishFileInput" type="file" webkitdirectory directory multiple />
                <p class="hint" id="publishFileHint">No file selected</p>
                <button id="createManifestBtn" class="primary" disabled>Create Manifest</button>
              </div>

              <div class="publish-step">
                <h4>2. Replicate (RF = 3)</h4>
                <div id="replicationProgress" class="replication-progress">
                  <p class="hint">Create manifest first</p>
                </div>
                <button id="startReplicationBtn" class="primary" disabled>Start Replication</button>
              </div>

              <div class="publish-step">
                <h4>Replica Settings</h4>
                <label class="toggle">
                  <input type="checkbox" id="autoReplicaToggle" checked />
                  <span>Auto-select replica peers</span>
                </label>

                <label for="replicaTargetCount">Max peers per upload</label>
                <input
                  id="replicaTargetCount"
                  type="number"
                  min="3"
                  max="20"
                  value="5"
                />

                <div class="manual-replicas" id="manualReplicaContainer">
                  <p class="hint">Manual selection is available when auto-select is disabled.</p>
                  <div id="manualReplicaList" class="manual-replica-list"></div>
                </div>

                <div class="replication-actions">
                  <button type="button" id="clearManualReplicasBtn" class="secondary-button" disabled>
                    Clear Manual Selections
                  </button>
                  <button type="button" id="resetReplicationSettingsBtn" class="secondary-button">
                    Reset Replication Settings
                  </button>
                </div>
              </div>

              <div class="publish-step">
                <h4>Persistence</h4>
                <label for="storageServiceUrl">Storage Service URL</label>
                <input
                  id="storageServiceUrl"
                  type="text"
                  value="http://34.107.74.70:8789"
                />

                <label for="storageApiKey">Storage API Key</label>
                <input
                  id="storageApiKey"
                  type="password"
                  placeholder="Required when STORAGE_API_KEYS is set"
                  value="storage-test-key"
                />

                <label class="toggle">
                  <input type="checkbox" id="inlineRegistryDataToggle" />
                  <span>Store chunk copies in registry</span>
                </label>

                <label class="toggle">
                  <input type="checkbox" id="storageFallbackToggle" />
                  <span>Upload fallback copies to storage service</span>
                </label>

                <p class="hint">
                  Toggle persistence features: enable to keep fallback copies, disable to rely purely on peer replicas.
                </p>
              </div>
            </div>

            <div class="replication-status" id="replicationStatus"></div>
          </div>

          <div class="card">
            <header>
<h3>Quick Domain Binding</h3>
              <div class="pill-group">
                <span class="pill" id="domainBindStatus">No domain bound</span>
              </div>
            </header>
            <div class="form-grid">
              <label for="domainInput">Domain (.dweb only)</label>
              <input id="domainInput" type="text" placeholder="example.dweb" pattern=".*\.dweb$" title="Domain must end with .dweb" />

              <label for="ownerInput">Owner ID</label>
              <input id="ownerInput" type="text" placeholder="user-123" />
            </div>
<p class="hint">Optional. For full management (transfer/delete/unbind), use the Domains or Bindings pages.</p>
            <div class="domain-actions">
              <button id="registerDomainBtn" class="primary" disabled>Bind Domain</button>
            </div>
            <div id="registryLog" class="log"></div>
          </div>
        </section>

        <section id="view-domains" class="view">
          <div class="card">
            <header>
              <h3>Domain Management</h3>
              <button id="refreshDomainsBtn" class="secondary-button small">Refresh</button>
            </header>
            <div class="domain-toolbar">
              <div class="domain-input-group">
                <input id="domainSearchInput" list="searchDomainsList" type="text" placeholder="example" style="flex: 1; border-top-right-radius: 0; border-bottom-right-radius: 0;" />
                <span class="domain-suffix">.dweb</span>
                <datalist id="searchDomainsList"></datalist>
              </div>
              <button id="registerNewDomainBtn" class="primary">Register Domain</button>
            </div>
            <table class="data-table" id="domainTable">
              <thead>
                <tr>
                  <th>Domain</th>
                  <th>Status</th>
                  <th>Manifest</th>
                  <th>Updated</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="domainsTableBody"></tbody>
            </table>
          </div>
        </section>

        <section id="view-bindings" class="view">
          <h2 class="view-title">Apps & Domain Bindings</h2>
          <p class="view-subtitle">Connect your published apps to .dweb domains</p>
          
          <div class="card">
            <header>
              <h3>Create New Binding</h3>
            </header>
            
            <div class="binding-creator">
              <div class="binding-row">
                <div class="binding-column">
                  <label>Select App</label>
                  <select id="bindingAppSelect" class="binding-select">
                    <option value="">-- Choose published app --</option>
                  </select>
                </div>
                
                <div class="binding-arrow">‚Üí</div>
                
                <div class="binding-column">
                  <label>Enter Domain</label>
                  <div class="domain-input-group">
                    <input id="bindingDomainInput" list="bindingDomainsList" type="text" placeholder="my-app" style="flex: 1; border-top-right-radius: 0; border-bottom-right-radius: 0;" />
                    <span class="domain-suffix">.dweb</span>
                    <datalist id="bindingDomainsList"></datalist>
                  </div>
                </div>
              </div>
              
              <button id="createBindingBtn" class="primary" style="width: 100%; margin-top: 20px;" disabled>Register Domain & Create Binding</button>
            </div>
          </div>
          
          <div class="card">
            <header>
              <h3>Your Bindings</h3>
              <button id="refreshBindingsBtn" class="secondary-button small">Refresh</button>
            </header>
            
            <div id="bindingsTableContainer" class="bindings-table-container">
              <div class="empty-state">
                <p class="empty-icon">üîó</p>
                <p class="empty-text">No bindings yet</p>
                <p class="empty-hint">Create a binding above to connect an app to a domain</p>
              </div>
            </div>
          </div>
        </section>

        <section id="view-peers" class="view" style="display:none;">
          <div class="card">
            <header>
              <h3>Active Peers</h3>
              <div class="peer-actions-inline">
                <label class="toggle">
                  <input type="checkbox" id="peerAutoSelectToggle" checked />
                  <span>Auto target selection</span>
                </label>
                <button id="refreshPeersBtn" class="secondary-button small">Refresh</button>
              </div>
            </header>
            <table class="data-table peers-table">
              <thead>
                <tr>
                  <th>Peer</th>
                  <th>Score</th>
                  <th>Latency</th>
                  <th>Success</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="peerTableBody"></tbody>
            </table>
            <div class="peer-detail">
              <label for="peerSelect">Select peer to connect</label>
              <div class="peer-connect">
                <select id="peerSelect"></select>
                <button id="openChannelBtn" disabled>Open Data Channel</button>
              </div>
              <ul id="peerList" class="peer-list"></ul>
            </div>
          </div>
        </section>

        <section id="view-activity" class="view" style="display:none;">
          <div class="card">
            <header>
              <h3>Selection Log</h3>
              <div class="export-buttons">
                <button id="selectionExportJson" class="secondary-button small">Copy JSON</button>
                <button id="selectionExportCsv" class="secondary-button small">Copy CSV</button>
              </div>
            </header>
            <div id="selectionLogContainer" class="log large"></div>
          </div>

          <div class="card">
            <header>
              <h3>Direct vs Relay (24h)</h3>
            </header>
            <canvas id="directRelayChart" width="400" height="180"></canvas>
          </div>
        </section>

        <section id="view-settings" class="view">
          <div class="card">
            <header>
              <h3>Environment</h3>
            </header>
            <div class="form-grid">
              <label for="envToggle">Target Environment</label>
              <select id="envToggle">
                <option value="production">Production (VPS)</option>
                <option value="local">Local Development</option>
              </select>
              <p class="hint" style="grid-column: 1 / -1;">Switch between local testing (localhost) and production (VPS) services. Local is recommended for development.</p>
            </div>
          </div>
          
          <div class="card">
            <header>
              <h3>Network Settings</h3>
            </header>
            <div class="form-grid">
              <label for="registryUrl">Registry Server</label>
              <input id="registryUrl" type="text" value="http://34.107.74.70:8788" readonly />

              <label for="registryApiKey">API Key (optional)</label>
              <input
                id="registryApiKey"
                type="password"
                placeholder="Leave blank for public access"
                value="registry-test-key"
              />
            </div>
          </div>
          
          <div class="card">
            <header>
              <h3>Account</h3>
            </header>
            <div class="account-info">
              <p><strong>Owner ID:</strong> <code id="settingsOwnerId">‚Äî</code></p>
              <p class="hint">This is your unique identifier for domain ownership.</p>
              <button id="signOutBtn" class="secondary">Sign Out & Clear Identity</button>
              <p class="hint" style="margin-top: 8px; color: var(--danger);">‚ö†Ô∏è Warning: This will permanently delete your cryptographic keypair. Export it first if you want to keep it.</p>
            </div>
          </div>
          
          <div class="card">
            <header>
              <h3>Background Peer Service</h3>
            </header>
            <label class="toggle">
              <input type="checkbox" id="toggleBackgroundPeer" checked />
              <span>Run as peer in background (recommended)</span>
            </label>
            <p class="hint">When enabled, you automatically participate in the P2P network even when the panel is closed. Your browser will store and serve chunks to other users, contributing to network resilience.</p>
            <div id="backgroundPeerStatus" class="status-info">
              <p><strong>Status:</strong> <span id="bgPeerStatusText">Checking...</span></p>
              <p><strong>Peer ID:</strong> <code id="bgPeerIdText">‚Äî</code></p>
              <p><strong>Connected Peers:</strong> <span id="bgPeerCountText">0</span></p>
              <button id="refreshBgPeerStatus" class="secondary small">Refresh Status</button>
            </div>
          </div>
          
          <details class="developer-section">
            <summary>Advanced Options</summary>
            <div class="dev-tools-content">
              <div class="card">
                <header>
                  <h3>Feature Flags</h3>
                </header>
                <div class="toggle-grid">
                  <label class="toggle">
                    <input type="checkbox" id="togglePeerFirst" checked />
                    <span>Peer-first mode</span>
                  </label>
                  <label class="toggle">
                    <input type="checkbox" id="toggleHealthScoring" checked />
                    <span>Health scoring</span>
                  </label>
                  <label class="toggle">
                    <input type="checkbox" id="toggleE2EAuto" checked />
                    <span>Auto E2E tests</span>
                  </label>
                  <label class="toggle">
                    <input type="checkbox" id="toggleRegistryFallback" />
                    <span>Registry fallback</span>
                  </label>
                </div>
              </div>
            </div>
          </details>
        </section>
      </div>
    </div>

    <script type="module" src="panel.js"></script>
    <!-- Faz 0: libp2p Test Module -->
    <script type="module" src="../dist/libp2p-test.js"></script>
  </body>
</html>
